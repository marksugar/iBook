![20190314-3](img/20190314-3.png)



åœ¨æ­¤å‰çš„åŸºäºgitlabçš„ci/cdä¸­ï¼Œæˆ‘å†™äº†å‡ ç¯‡æ–‡ç« æ¥è¯´æ˜ä»–çš„åŸºæœ¬ç”¨æ³•ï¼Œæˆ‘å°†ä¼šåœ¨åç»­çš„æ–‡ç« ä¸­ä¸æ–­æ¥å®Œå–„gitlabå’Œjenkinsçš„ç”¨æ³•ã€‚

é˜…è¯»æœ¬ç« ï¼Œä½ å°†äº†è§£gitlabåŸºäºciçš„å®šæ—¶ä»»åŠ¡ã€‚

## å®‰è£…é…ç½®gitlab-runner

å‚è€ƒ[å®˜ç½‘çš„å®‰è£…æ‰‹å†Œ](https://docs.gitlab.com/runner/install/linux-repository.html#installing-the-runner)è¿›è¡Œå®‰è£…å³å¯

```
yum install gitlab-runner
```
è€Œåå¯ä»¥å¸¸ç”¨dockeræˆ–è€…shellçš„æ–¹å¼æ¥é€‰æ‹©åç»­å‘½ä»¤æ‰§è¡Œçš„ç¯å¢ƒ

> è·å–tokenï¼Œå‚è€ƒæ­¤å‰çš„[å®‰è£…é…ç½®æ–‡ç« ](https://www.linuxea.com/1800.html#%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AErunners)

- docker

```
gitlab-runner register \
  --non-interactive \
  --url "http://git.ds.com/" \
  --registration-token "jQj1Fi2xd53xqg3ZeMVU" \
  --executor "docker" \
  --docker-image alpine:3.9 \
  --description "docker-runner" \
  --tag-list "docker,shell" \
  --run-untagged \
  --locked="false"
```

- shell

```
gitlab-runner register \
  --non-interactive \
  --url "http://git.xx.com/" \
  --registration-token "jQj1Fi2xd53xqg3ZeMVU" \
  --executor "shell" \
  --description "docker-runner" \
  --tag-list "docker,shell" \
  --run-untagged \
  --locked="false"
```

æˆ‘è¿™é‡Œä½¿ç”¨çš„shell

```
root@linuxea.com ğŸ³ ~ â˜¸   2019-03-14 15:48:43 
$ gitlab-runner register \
>   --non-interactive \
>   --url "http://git.xx.com/" \
>   --registration-token "jQj1Fi2xd53xqg3ZeMVU" \
>   --executor "shell" \
>   --description "docker-runner" \
>   --tag-list "docker,shell" \
>   --run-untagged \
>   --locked="false"
Runtime platform                                    arch=amd64 os=linux pid=13181 revision=4745a6f3 version=11.8.0
Running in system-mode.                                              
Registering runner... succeeded                     runner=jQj1Fi2x
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded! 
```

é…ç½®æ–‡ä»¶ä½ç½®

```
root@linuxea.com ğŸ³ ~ â˜¸    2019-03-14 15:49:34 
$ cat /etc/gitlab-runner/config.toml 
concurrent = 1
check_interval = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "docker-runner"
  url = "http://git.ds.com/"
  token = "b5819c16ec11f45e8b6a59175453ec"
  executor = "shell"
  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]
```

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé…ç½®å®Œæˆæˆ‘ä»¬éœ€è¦é‡å¯ä¸€ä¸‹ï¼Œå°½ç®¡æç¤ºè¯´ä¼šç”Ÿæ•ˆ

```
systemctl restart gitlab-runner.service 
```

å¦‚æœä¸æƒ³é‡å¯ï¼Œå¯ä»¥é€šè¿‡listæŸ¥çœ‹ï¼Œå¹¶ä½¿ç”¨statusæŸ¥çœ‹æ˜¯å¦runing

```
root@linuxea.com ğŸ³ ~ â˜¸  2019-03-14 15:50:34 
$ gitlab-runner list
Runtime platform                                    arch=amd64 os=linux pid=14411 revision=4745a6f3 version=11.8.0
Listing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml
docker-runner                                       Executor=shell Token=b5819c16ec11f45e8b6a59175453ec URL=http://git.ds.com/
```

```
root@linuxea.com ğŸ³ ~ â˜¸  2019-03-14 15:51:30 
$ gitlab-runner status docker-runner 
Runtime platform                                    arch=amd64 os=linux pid=14523 revision=4745a6f3 version=11.8.0
gitlab-runner: Service is running!
```

å¦‚æœæ²¡æœ‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨gitlab-runner start docker-runneræ¥è¿›è¡Œå¯åŠ¨

## æµ‹è¯•è®¡åˆ’ä»»åŠ¡

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé¡¹ç›®ç”¨ä½œæµ‹è¯•ï¼Œå¹¶ä¸”å†™ä¸€ä¸ªç®€å•çš„å‘½ä»¤ï¼Œå‘½åä¸º`.gitlab-ci.yml`

```
stages:
  - test
1/1 test:
  stage: test
  script: 
    - a=$(curl -s curlip.me|awk 'NR==5{print $2" "$3}')
    - echo $a
```

å¦‚ä¸‹å›¾

![20190314-1](img/20190314-1.png)

ç„¶åæˆ‘ä»¬å°†ä½¿ç”¨GitLab-CIå®‰æ’å®ƒæ¯å¤©è¿è¡Œã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬é…ç½®"æ—¥ç¨‹è¡¨"(æ±‰åŒ–åå«æ—¥ç¨‹è¡¨)ã€‚CI/CD ---> æ—¥ç¨‹è¡¨--->æ–°å»ºè®¡åˆ’ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡çš„è®¡åˆ’ã€‚è¿™é‡Œçš„å®šæ—¶ï¼Œå–å†³äº[croné…ç½®](https://baike.baidu.com/item/cron/10952601?fr=aladdin)ã€‚é‚£ä¹ˆè¡¨ç°çš„å½¢å¼å¤§è‡´å¦‚ä¸‹

![20190314-2](img/20190314-2.png)

ä¸è¿‡ï¼Œè¿™æ ·ä½ ä¼šå‘ç°ï¼Œä»–åªä¼šè¿è¡Œä¸€æ¬¡ï¼Œè€Œåå°†éµå¾ª1å°æ—¶è¿è¡Œä¸€æ¬¡çš„è§„å¾‹

è¿™äº›ä¿¡æ¯åœ¨[gitlabç¤¾åŒºæœ‰è¿‡è®¨è®º](https://gitlab.com/gitlab-org/gitlab-ce/issues/45695)ï¼Œå¾—å‡ºçš„ç»“æœï¼Œä¹Ÿå°±æ˜¯å¦‚æœä¸€ä¸ªjobè®¾ç½®äº†è®¡åˆ’ï¼Œé‚£ä¹ˆæœ€å°çš„ç²’åº¦æ˜¯1å°æ—¶

## å»¶ä¼¸é˜…è¯»

- [å®‰è£…runner](https://docs.gitlab.com/runner/install/linux-repository.html#installing-the-runner)

- [é…ç½®runner](https://docs.gitlab.com/runner/register/)

## æŸ¥çœ‹æ›´å¤š

å¦‚æœä½ è¦æŸ¥çœ‹æ›´å¤šå…³äºjenkinså’Œgitlab-ci/cdçš„æ–‡ç« ï¼Œè¯·å…³æ³¨ä¸€ä¸‹åˆ†ç±»ã€‚

- [gitlab-ci/cd](https://www.linuxea.com/tag/gitlab/)
- [jenkins](https://www.linuxea.com/tag/jenkins/)